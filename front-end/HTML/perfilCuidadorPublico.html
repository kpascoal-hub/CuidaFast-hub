<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil do Cuidador - CuidaFast</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../assets/icone_verde.svg">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../CSS/main.css">
    <link rel="stylesheet" href="../CSS/header.css">
    <style>
        .caregiver-profile-page {
            padding-top: 100px;
            min-height: 100vh;
            background: var(--bege);
        }

        .profile-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--azul-escuro);
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            gap: 0.75rem;
            color: var(--amarelo-sólido);
        }

        .profile-header {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            display: flex;
            gap: 2rem;
            align-items: start;
        }

        .profile-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--azul-escuro);
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 2rem;
            font-weight: 700;
            color: var(--azul-escuro);
            margin-bottom: 0.5rem;
        }

        .profile-specialty {
            font-size: 1.25rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .profile-rating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .stars {
            color: var(--amarelo-sólido);
            font-size: 1.25rem;
        }

        .rating-text {
            font-size: 1rem;
            color: #666;
        }

        .profile-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .btn-primary {
            background: #1B475D;
            color: white;
        }

        .btn-primary:hover {
            background: #163947;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(27, 71, 93, 0.3);
        }

        .btn-secondary {
            background: #1B475D;
            color: white;
        }

        .btn-secondary:hover {
            background: #163947;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(27, 71, 93, 0.3);
        }

        .profile-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .detail-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .detail-card h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--azul-escuro);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .detail-card h3 i {
            font-size: 1.75rem;
        }

        .detail-item {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(27, 71, 93, 0.1);
        }

        .detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .detail-label {
            font-weight: 600;
            color: var(--azul-escuro);
            margin-bottom: 0.25rem;
        }

        .detail-value {
            color: #666;
        }

        .bio-text {
            line-height: 1.6;
            color: #666;
        }

        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                text-align: center;
                align-items: center;
            }

            .profile-actions {
                flex-direction: column;
                width: 100%;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body class="caregiver-profile-page">
    <!-- Header -->
    <header class="modern-header">
        <div class="header-container">
            <!-- Logo Section -->
            <div class="header-left">
                <a href="homeCliente.html" class="logo-link">
                    <img src="../assets/Logotipo_1_vetorizado.svg" alt="Logotipo CuidaFast" class="logo" />
                </a>
            </div>
            
            <!-- Barra de Pesquisa -->
            <div class="header-center">
                <div class="search-container">
                    <i class="ph ph-magnifying-glass search-icon"></i>
                    <input type="text" class="search-input" placeholder="Buscar cuidadores...">
                    <button class="search-btn" type="button">
                        <i class="ph ph-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- User Actions -->
            <div class="header-right">
                <!-- Notifications -->
                <a href="notificacoes.html" class="header-action-btn notification-btn">
                    <i class="ph ph-bell"></i>
                    <span class="notification-badge">0</span>
                </a>
                
                <!-- Messages -->
                <a href="mensagens.html" class="header-action-btn message-btn">
                    <i class="ph ph-chat-circle"></i>
                    <span class="message-badge">0</span>
                </a>
                
                <!-- User Profile -->
                <div class="user-profile-dropdown" id="userProfileDropdown">
                    <button class="user-profile-btn" id="userProfileBtn">
                        <img src="../assets/images.webp" alt="Avatar do usuário" class="user-avatar-img">
                        <span class="user-name" id="headerUserName">Cliente</span>
                        <i class="ph ph-caret-down dropdown-arrow"></i>
                    </button>
                    
                    <!-- Dropdown Menu -->
                    <div class="profile-dropdown-menu" id="profileDropdownMenu">
                        <div class="dropdown-header">
                            <img src="../assets/images.webp" alt="Avatar" class="dropdown-avatar">
                            <div class="dropdown-user-info">
                                <h4 id="dropdownUserName">Cliente</h4>
                                <p>Conta Pessoal</p>
                            </div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a href="perfilCliente.html" class="dropdown-item">
                            <i class="ph ph-user"></i>
                            <span>Meu Perfil</span>
                        </a>
                        <a href="configuracoes.html" class="dropdown-item">
                            <i class="ph ph-gear"></i>
                            <span>Configurações</span>
                        </a>
                        <a href="homeCliente.html" class="dropdown-item">
                            <i class="ph ph-house"></i>
                            <span>Início</span>
                        </a>
                        <a href="#" class="dropdown-item">
                            <i class="ph ph-question"></i>
                            <span>Ajuda</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item logout-item" id="headerLogoutBtn">
                            <i class="ph ph-sign-out"></i>
                            <span>Sair</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="profile-container">
        <a href="homeCliente.html" class="back-button">
            <i class="ph ph-arrow-left"></i>
            Voltar para busca
        </a>

        <!-- Profile Header -->
        <div class="profile-header">
            <img src="../assets/images.webp" alt="Foto do cuidador" class="profile-avatar" id="caregiverAvatar">
            
            <div class="profile-info">
                <h1 class="profile-name" id="caregiverName">Carregando...</h1>
                <p class="profile-specialty" id="caregiverSpecialty">Especialidade</p>
                
                <div class="profile-rating">
                    <div class="stars" id="caregiverStars">
                        <i class="ph-fill ph-star"></i>
                        <i class="ph-fill ph-star"></i>
                        <i class="ph-fill ph-star"></i>
                        <i class="ph-fill ph-star"></i>
                        <i class="ph-fill ph-star"></i>
                    </div>
                    <span class="rating-text" id="caregiverRating">5.0 (0 avaliações)</span>
                </div>

                <div class="profile-actions">
                    <button class="btn btn-primary" id="btnContratar">
                        <i class="ph ph-check-circle"></i>
                        Contratar Cuidador
                    </button>
                    <button class="btn btn-secondary" id="btnMensagem">
                        <i class="ph ph-chat-circle"></i>
                        Enviar Mensagem
                    </button>
                </div>
            </div>
        </div>

        <!-- Profile Details -->
        <div class="profile-details">
            <!-- Sobre -->
            <div class="detail-card">
                <h3>
                    <i class="ph ph-user-circle"></i>
                    Sobre
                </h3>
                <p class="bio-text" id="caregiverBio">Carregando informações...</p>
            </div>

            <!-- Informações de Contato -->
            <div class="detail-card">
                <h3>
                    <i class="ph ph-address-book"></i>
                    Contato
                </h3>
                <div class="detail-item">
                    <div class="detail-label">Email</div>
                    <div class="detail-value" id="caregiverEmail">-</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Telefone</div>
                    <div class="detail-value" id="caregiverPhone">-</div>
                </div>
            </div>

            <!-- Localização -->
            <div class="detail-card" id="locationCard" style="display: none;">
                <h3>
                    <i class="ph ph-map-pin"></i>
                    Localização
                </h3>
                <div class="detail-item">
                    <div class="detail-label">Cidade</div>
                    <div class="detail-value" id="caregiverCity">-</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Estado</div>
                    <div class="detail-value" id="caregiverState">-</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de Contratação -->
    <div class="modal fade" id="modalContratar" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 16px; border: none;">
                <div class="modal-header" style="background: var(--azul-escuro); color: white; border-radius: 16px 16px 0 0;">
                    <h5 class="modal-title">
                        <i class="ph ph-check-circle"></i>
                        Contratar Cuidador
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding: 2rem;">
                    <p style="margin-bottom: 1.5rem; color: #666;">
                        Você está prestes a contratar <strong id="modalCaregiverName"></strong> para prestar serviços de cuidado.
                    </p>
                    
                    <form id="formContratar">
                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 600; color: var(--azul-escuro);">
                                <i class="ph ph-list"></i>
                                Tipo de Serviço
                            </label>
                            <select class="form-select" id="tipoServico" required style="border: 2px solid #e0e0e0; border-radius: 10px; padding: 0.75rem;">
                                <option value="">Selecione o tipo de serviço</option>
                                <option value="idoso">Cuidado de Idosos</option>
                                <option value="crianca">Cuidado Infantil</option>
                                <option value="pet">Cuidado de Pets</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 600; color: var(--azul-escuro);">
                                <i class="ph ph-note"></i>
                                Observações (opcional)
                            </label>
                            <textarea class="form-control" id="observacoes" rows="3" placeholder="Descreva suas necessidades específicas..." style="border: 2px solid #e0e0e0; border-radius: 10px; padding: 0.75rem;"></textarea>
                        </div>
                        
                        <div class="alert alert-info" style="background: rgba(27, 71, 93, 0.1); border: 1px solid var(--azul-escuro); border-radius: 10px;">
                            <i class="ph ph-info"></i>
                            <small>O cuidador receberá sua solicitação e poderá aceitá-la. Você será notificado quando houver uma resposta.</small>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="flex: 1;">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                <i class="ph ph-check"></i>
                                Confirmar Contratação
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Serviços Manager -->
    <script src="../JS/servicosManager.js"></script>
    
    <!-- API de Perfis (SEGURO - Backend) -->
    <script src="../JS/perfilAPI.js"></script>

    <script>
        // Carregar dados do cuidador via API do backend
        document.addEventListener('DOMContentLoaded', async function() {
            // Carregar dados do cliente no header
            const clienteData = JSON.parse(localStorage.getItem('cuidafast_user') || '{}');
            
            if (clienteData && clienteData.nome) {
                const primeiroNome = clienteData.primeiroNome || clienteData.nome.split(' ')[0];
                const headerUserName = document.getElementById('headerUserName');
                const dropdownUserName = document.getElementById('dropdownUserName');
                
                if (headerUserName) headerUserName.textContent = primeiroNome;
                if (dropdownUserName) dropdownUserName.textContent = clienteData.nome;
                
                // Atualizar foto do perfil
                if (clienteData.photoURL) {
                    const headerAvatar = document.querySelector('.user-avatar-img');
                    const dropdownAvatar = document.querySelector('.dropdown-avatar');
                    
                    if (headerAvatar) headerAvatar.src = clienteData.photoURL;
                    if (dropdownAvatar) dropdownAvatar.src = clienteData.photoURL;
                }
            }

            // Configurar dropdown menu
            const userProfileBtn = document.getElementById('userProfileBtn');
            const profileDropdownMenu = document.getElementById('profileDropdownMenu');
            
            if (userProfileBtn && profileDropdownMenu) {
                userProfileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    profileDropdownMenu.classList.toggle('show');
                });
                
                document.addEventListener('click', function(e) {
                    if (!userProfileBtn.contains(e.target) && !profileDropdownMenu.contains(e.target)) {
                        profileDropdownMenu.classList.remove('show');
                    }
                });
            }

            // Configurar logout
            const logoutBtn = document.getElementById('headerLogoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    localStorage.removeItem('cuidafast_isLoggedIn');
                    window.location.href = '../../index.html';
                });
            }

            try {
                // ✅ NOVO: Obter ID do cuidador da URL (ao invés de email)
                const urlParams = new URLSearchParams(window.location.search);
                const cuidadorId = urlParams.get('id');
                
                if (!cuidadorId) {
                    alert('Cuidador não especificado.');
                    window.location.href = 'homeCliente.html';
                    return;
                }

                // ✅ NOVO: Buscar dados do cuidador via API do backend (SEGURO)
                console.log('[PerfilCuidador] Buscando perfil do cuidador ID:', cuidadorId);
                const caregiver = await PerfilAPI.buscarPerfilCuidador(cuidadorId);
                console.log('[PerfilCuidador] Perfil carregado:', caregiver.nome);

                // ✅ NOVO: Preencher página automaticamente com função auxiliar
                PerfilAPI.preencherPerfilCuidador(caregiver);
                
                // Dados adicionais que não estão na função auxiliar
                const rating = caregiver.avaliacao || 0;
                const reviews = 0; // TODO: buscar do backend
                
                if (rating > 0) {
                    document.getElementById('caregiverRating').textContent = `${rating.toFixed(1)} (${reviews} avaliações)`;
                    
                    // Renderizar estrelas
                    const starsContainer = document.getElementById('caregiverStars');
                    const fullStars = Math.floor(rating);
                    const hasHalfStar = rating % 1 >= 0.5;
                    let starsHTML = '';
                    
                    for (let i = 0; i < fullStars; i++) {
                        starsHTML += '<i class="ph-fill ph-star"></i>';
                    }
                    if (hasHalfStar) {
                        starsHTML += '<i class="ph ph-star-half"></i>';
                    }
                    for (let i = Math.ceil(rating); i < 5; i++) {
                        starsHTML += '<i class="ph ph-star"></i>';
                    }
                    starsContainer.innerHTML = starsHTML;
                }

                // Localização
                if (caregiver.local_trabalho) {
                    const partes = caregiver.local_trabalho.split(',');
                    document.getElementById('locationCard').style.display = 'block';
                    document.getElementById('caregiverCity').textContent = partes[0]?.trim() || '-';
                    document.getElementById('caregiverState').textContent = partes[1]?.trim() || '-';
                }

                // Botão Contratar - Abrir modal
                document.getElementById('btnContratar').addEventListener('click', function() {
                    // Verificar se cliente está logado
                    const clienteData = JSON.parse(localStorage.getItem('cuidafast_user') || '{}');
                    
                    if (!clienteData.email || clienteData.tipo !== 'cliente') {
                        alert('⚠️ Você precisa estar logado como cliente para contratar um cuidador.');
                        window.location.href = '../../index.html';
                        return;
                    }
                    
                    // Preencher nome do cuidador no modal
                    document.getElementById('modalCaregiverName').textContent = caregiver.nome || 'este cuidador';
                    
                    // Abrir modal
                    const modal = new bootstrap.Modal(document.getElementById('modalContratar'));
                    modal.show();
                });
                
                // Formulário de contratação
                document.getElementById('formContratar').addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const clienteData = JSON.parse(localStorage.getItem('cuidafast_user') || '{}');
                    const tipoServico = document.getElementById('tipoServico').value;
                    const observacoes = document.getElementById('observacoes').value;
                    
                    if (!tipoServico) {
                        alert('Por favor, selecione o tipo de serviço.');
                        return;
                    }
                    
                    // Verificar se ServicosManager está disponível
                    if (typeof ServicosManager === 'undefined') {
                        console.error('[Contratação] ServicosManager não carregado');
                        alert('❌ Erro ao processar contratação. Tente novamente.');
                        return;
                    }
                    
                    try {
                        // Criar serviço
                        const servico = ServicosManager.criarServico(
                            caregiver.email,
                            clienteData.email,
                            clienteData.nome,
                            tipoServico
                        );
                        
                        // Adicionar observações ao serviço
                        if (observacoes) {
                            let servicos = ServicosManager.getServicos();
                            const index = servicos.findIndex(s => s.id === servico.id);
                            if (index !== -1) {
                                servicos[index].observacoes = observacoes;
                                localStorage.setItem('cuidafast_servicos', JSON.stringify(servicos));
                            }
                        }
                        
                        console.log('[Contratação] Serviço criado:', servico);
                        
                        // Fechar modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('modalContratar'));
                        modal.hide();
                        
                        // Mostrar mensagem de sucesso
                        alert(`✅ Solicitação enviada com sucesso!\n\nO cuidador ${caregiver.name} receberá sua solicitação e você será notificado quando houver uma resposta.\n\nID do Serviço: ${servico.id}`);
                        
                        // Redirecionar para página inicial do cliente
                        window.location.href = 'homeCliente.html';
                        
                    } catch (error) {
                        console.error('[Contratação] Erro ao criar serviço:', error);
                        alert('❌ Erro ao processar contratação. Tente novamente.');
                    }
                });

                // Botão Mensagem - Abrir chat com o cuidador
                document.getElementById('btnMensagem').addEventListener('click', function() {
                    // Verificar se cliente está logado
                    const clienteData = JSON.parse(localStorage.getItem('cuidafast_user') || '{}');
                    
                    if (!clienteData.email || clienteData.tipo !== 'cliente') {
                        alert('⚠️ Você precisa estar logado como cliente para enviar mensagens.');
                        window.location.href = '../../index.html';
                        return;
                    }
                    
                    // Redirecionar para mensagens com o ID do cuidador
                    window.location.href = `mensagens.html?destinatario=${cuidadorId}`;
                });

            } catch (error) {
                console.error('[PerfilCuidador] Erro ao carregar dados:', error);
                alert('Erro ao carregar perfil do cuidador.');
                window.location.href = 'homeCliente.html';
            }
        });
    </script>
</body>
</html>
